#!/usr/bin/env python
"""
Obtain cDNA alignments from an Ensembl database.
"""
from __future__ import print_function
import icedbProgSetup  # noqa: F401
import sys
import argparse
from pycbio.hgdata import hgDb
from pycbio.sys import dbOps
from pycbio.ncbi.assembly import AssemblyReport
import eutils.client
import MySQLdb
import MySQLdb.cursors

ensDbHost = "ensembldb.ensembl.org"
ensDbPort = 5306
ensDbUser = "anonymous"

def parseArgs():
    desc = """Fetch cDNA alignments from Ensembl and load as PSLs in evidence
    sqllite3 database.

    The Ensembl alignments don't include the poly-A and lack the lengths,
    The length of cDNA sequences are obtained from either the UCSC browser
    database or NCBI eutils API.
"""
    parser = argparse.ArgumentParser(description=desc)
    parser.add_argument('--hgFixedDb', default="hgFixed",
                        help="""hgFixed database to use to get sizes""")
    parser.add_argument('--limit', type=int,
                        help="""limit on query resuts, used for tests """)
    parser.add_argument('ensemblCDnaDb',
                        help="""Ensembl cDNA database to use""")
    parser.add_argument('assemblyReport',
                        help="""NCBI assembly report for mapping chromosome names""")
    parser.add_argument('pslOut',
                        help="""PSL of alignments""")
    opts = parser.parse_args()
    return opts

ensCDnaAlnQuery = """SELECT
    daf.hit_name, daf.hit_strand, daf.hit_start, daf.hit_end,
    sr.name, sr.length, daf.seq_region_strand, daf.seq_region_start, daf.seq_region_end,
    daf.cigar_line
  FROM
    dna_align_feature daf, seq_region sr, external_db ed, transcript_supporting_feature tsf
  WHERE
    ((daf.seq_region_id = sr.seq_region_id)
     AND (daf.external_db_id = ed.external_db_id)
     AND (ed.db_name = "EMBL")
     AND (daf.dna_align_feature_id = tsf.feature_id)
     AND (tsf.feature_type = "dna_align_feature"))"""


class CDnaSizeFinder(object):
    "work around the fact that Ensembl doesn't have cDNA sizes"
    def __init__(self, hgFixedDb):
        self.hgFixedConn = hgDb.connect(hgFixedDb)
        self.eclient = eutils.client.Client()

    def __getSizeUcsc(self, accver):
        acc, ver = accver.split('.')
        cur = self.hgFixedConn.cursor()
        try:
            sql = """select size from gbSeq where (acc = %s) and (version = %s)"""
            cur.execute(sql, (acc, int(ver)))
            row = cur.fetchone()
            if row == None:
                return None
            else:
                return row[0]
        finally:
            cur.close()

    def __getSizeEutils(self, accver):
        esr = self.eclient.esearch(db='nuccore', term=accver)
        if len(esr.ids) == 0:
            return None
        if len(esr.ids) > 1:
            raise Exception("multiple results return for eutil query for `{}'".format(accver))
        efr = self.eclient.efetch(db='nuccore', id=esr.ids[0])
        return efr.gbseqs[0].length

    def getSize(self, accver):
        size = self.__getSizeUcsc(accver)
        if size is None:
            size = self.__getSizeEutils(accver)
        if size is None:
            print("Note: UCSC and eutils esearch can't find `{}'".format(accver), file=sys.stderr)
        return size

def ensemblCDnaQuery(ensemblCDnaDb, limit=None):
    "generator of cDNA alignments from Ensembl"
    conn = MySQLdb.Connect(host=ensDbHost, port=ensDbPort, user=ensDbUser,
                           db=ensemblCDnaDb, cursorclass=MySQLdb.cursors.DictCursor)
    sql = ensCDnaAlnQuery
    if limit is not None:
        sql += " LIMIT {}".format(limit)
    try:
        cur = conn.cursor()
        cur.execute(sql)
        for row in cur:
            yield row
    finally:
        conn.close()


def convertAlign(row, cDnaSizeFinder, asmReport, pslOutFh):
    size = cDnaSizeFinder.getSize(row["hit_name"])
    print(row["hit_name"], size, file=pslOutFh)
        
def ensemblCDnaToPsl(ensemblCDnaDb, limit, cDnaSizeFinder, asmReport, pslOutFh):
    for row in ensemblCDnaQuery(ensemblCDnaDb, limit):
        convertAlign(row, cDnaSizeFinder, asmReport, pslOutFh)

def cdnaEnsemblAligns(opts):
    "main function"
    cDnaSizeFinder = CDnaSizeFinder(opts.hgFixedDb)
    asmReport = AssemblyReport(opts.assemblyReport)
    with open(opts.pslOut, "w") as pslOutFh:
        ensemblCDnaToPsl(opts.ensemblCDnaDb, opts.limit, cDnaSizeFinder, asmReport, pslOutFh),

dbOps.mySqlSetErrorOnWarn()
cdnaEnsemblAligns(parseArgs())
