#!/usr/bin/env python

from __future__ import print_function
import icedbProgSetup  # noqa: F401
import argparse
from pycbio.hgdata.hgLite import GencodeAttrsDbTable, GencodeTranscriptSourceDbTable, GenePredDbTable, GencodeTranscriptionSupportLevelDbTable
from pycbio.hgdata import hgDb
import sqlite3
from gencode_icedb.general import gencodeDb


def parseArgs():
    desc = """Load GENCODE genePreds and attributes into sqlite databases."""
    parser = argparse.ArgumentParser(description=desc)
    parser.add_argument('--hgdb',
                        help="""load from mysql hgdb instead of files""")
    parser.add_argument('sqliteDb',
                        help="""database to load""")
    parser.add_argument('attrsSrc',
                        help="""TSV file or table of GENCODE attributes""")
    parser.add_argument('transcriptSourceSrc',
                        help="""TSV file or table of GENCODE transcript sources""")
    parser.add_argument('transcriptionSupportLevelSrc',
                        help="""TSV file or table of GENCODE transcription support level scores""")
    parser.add_argument('genePredSrc',
                        help="""file or table of genePreds to load""")
    parser.add_argument('pseudoPredSrc', nargs='?', default=None,
                        help="""optional file or table of pseudo genePreds to load""")
    return parser.parse_args()


def loadHgDbTable(hgdbConn, tbl):
    cur = hgdbConn.cursor()
    try:
        cur.execute("SELECT * from {}".format(tbl))
        return cur.fetchall()
    finally:
        cur.close()


def loadAnnotations(conn, hgdbConn, genePredSrc, pseudoPredSrc):
    annDbTable = GenePredDbTable(conn, gencodeDb.gencode_ann_table, create=True)
    if hgdbConn is not None:
        annDbTable.loadsWithBin(loadHgDbTable(hgdbConn, genePredSrc))
        if pseudoPredSrc is not None:
            annDbTable.loadsWithBin(loadHgDbTable(hgdbConn, pseudoPredSrc))
    else:
        annDbTable.loadGenePredFile(genePredSrc)
        if pseudoPredSrc is not None:
            annDbTable.loadGenePredFile(pseudoPredSrc)


def loadAttrs(conn, hgdbConn, attrsSrc):
    attrsDbTable = GencodeAttrsDbTable(conn, gencodeDb.gencode_attrs_table, create=True)
    if hgdbConn is not None:
        attrsDbTable.loads(loadHgDbTable(hgdbConn, attrsSrc))
    else:
        attrsDbTable.loadTsv(attrsSrc)


def loadTransSource(conn, hgdbConn, transSourceSrc):
    transSourceDbTable = GencodeTranscriptSourceDbTable(conn, gencodeDb.gencode_transcript_source_table, create=True)
    if hgdbConn is not None:
        transSourceDbTable.loads(loadHgDbTable(hgdbConn, transSourceSrc))
    else:
        transSourceDbTable.loadTsv(transSourceSrc)


def loadTransSupportLevel(conn, hgdbConn, transSupportLevelSrc):
    transSourceDbTable = GencodeTranscriptionSupportLevelDbTable(conn, gencodeDb.gencode_transcription_support_level_table, create=True)
    if hgdbConn is not None:
        transSourceDbTable.loads(loadHgDbTable(hgdbConn, transSupportLevelSrc))
    else:
        transSourceDbTable.loadTsv(transSupportLevelSrc)


def gencodeDbLoad(opts):
    "main function"
    conn = sqlite3.connect(opts.sqliteDb)
    hgdbConn = None
    if opts.hgdb is not None:
        hgdbConn = hgDb.connect(opts.hgdb)
    loadAnnotations(conn, hgdbConn, opts.genePredSrc, opts.pseudoPredSrc)
    loadAttrs(conn, hgdbConn, opts.attrsSrc)
    loadTransSource(conn, hgdbConn, opts.transcriptSourceSrc)
    loadTransSupportLevel(conn, hgdbConn, opts.transcriptionSupportLevelSrc)
    if hgdbConn is not None:
        hgdbConn.close()
    conn.close()


gencodeDbLoad(parseArgs())
