#!/usr/bin/env python

from __future__ import print_function
import icedbProgSetup  # noqa: F401
import os
import argparse
import sqlite3
from pycbio.sys import fileOps
from pycbio.hgdata.hgLite import GencodeAttrsDbTable
from gencode_icedb.general import gencodeDb
from gencode_icedb.general.genome import GenomeReaderFactory


def parseArgs():
    desc = """Generate parasol jobs to collect splice site evidence for all GENCODE."""
    parser = argparse.ArgumentParser(description=desc)
    GenomeReaderFactory.addCmdOptions(parser)
    parser.add_argument("--maxgenes", type=int, default=None,
                        help="""maximum number of genes to use, for testing""")
    parser.add_argument("--genesPerJob", type=int, default=1,
                        help="""number of genes in a job""")
    parser.add_argument('gencodeDb',
                        help="""GENCODE sqlite3 database from gencodeDbLoad""")
    parser.add_argument('sjDb',
                        help="""splice junction evidence sqlite3 database, a correspond *.sjsup.gz and tabix index file must exist""")
    parser.add_argument('workDir',
                        help="""directory where jobFile and temporary results are stored""")
    return parser.parse_args()


class JobGenerator(object):
    def __init__(self, gencodeDb, sjDb, genomeReaderFactory, workDir):
        self.gencodeDb = gencodeDb
        self.sjDb = sjDb
        self.genomeReaderFactory = genomeReaderFactory
        self.workDir = workDir
        self.resultDir = os.path.join(workDir, "results")
        self.suppProg = os.path.join(icedbProgSetup.binDir, "rslGencodeCollectSupportJob")

    def __generateJob(self, gencodeIds, batchFh, expectedFh):
        cmd = [self.suppProg] + self.genomeReaderFactory.getOptionArgs(allowUpdate=False)
        resultTsv = os.path.join(self.resultDir, "{}.supp.tsv".format(gencodeIds[0]))
        cmd.extend([self.gencodeDb, self.sjDb, "{{check out exists {}}}".format(resultTsv)])
        cmd.extend(gencodeIds)
        print(*cmd, file=batchFh)
        print(resultTsv, file=expectedFh)

    def generateJobs(self, gencodeIds, genesPerJob, batchFh, expectedFh):
        iNext = 0
        while iNext < len(gencodeIds):
            self.__generateJob(gencodeIds[iNext: iNext + genesPerJob], batchFh, expectedFh)
            iNext += genesPerJob


def rslGencodeCollectSupportMkJobs(opts):
    "main function"
    genomeReaderFactory = GenomeReaderFactory.factoryFromCmdOptions(opts)
    gencodeConn = sqlite3.connect(opts.gencodeDb)  # FIXME: switch to APSW read-only
    attrsDbTable = GencodeAttrsDbTable(gencodeConn, gencodeDb.gencode_attrs_table)
    gencodeIds = sorted(attrsDbTable.getAllGeneIds())
    if opts.maxgenes is not None:
        gencodeIds = gencodeIds[0:opts.maxgenes]
    jobGen = JobGenerator(opts.gencodeDb, opts.sjDb, genomeReaderFactory, opts.workDir)

    fileOps.ensureDir(opts.workDir)
    batchFile = os.path.join(opts.workDir, "batch.jobs")
    expectedLst = os.path.join(opts.workDir, "expected.lst")
    with open(batchFile, "w") as batchFh, open(expectedLst, "w") as expectedFh:
        jobGen.generateJobs(gencodeIds, opts.genesPerJob, batchFh, expectedFh)
    gencodeConn.close()


rslGencodeCollectSupportMkJobs(parseArgs())
