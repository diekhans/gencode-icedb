#!/usr/bin/env python
from __future__ import print_function
import icedbProgSetup  # noqa: F401
import sys
import os
import argparse
from gencode_icedb.rsl.rnaSeqData import setDatabase, RnaSeqData
from gencode_icedb.rsl import config
from pycbio.sys import fileOps, loggingOps
from peewee import SqliteDatabase
import logging
import pipettor


def parseArgs():
    desc = """Collect and combine splice junction support.  This
    used the C program rslSpliceJunctionCollectEvidence to do the real work.
    """
    parser = argparse.ArgumentParser(description=desc)
    loggingOps.addCmdOptions(parser)
    parser.add_argument('--rootDir', default=".",
                        help="""data root directory""")
    parser.add_argument('--minOverhang', default=0, type=int,
                        help="""minimum overhang for a STAR splice junction call. Records with less than this maximum overhang have splice\n"
                        junction information discarded.  They will still be
                        reported if part of the target set""")
    parser.add_argument('organism',
                        help="""common name of organism""")
    parser.add_argument('assembly',
                        help="""assembly name""")
    parser.add_argument('geneSet',
                        help="""gene set name""")
#   FIXME these should come from config
    parser.add_argument('gencodeGenePred',
                        help="""gene gene predfile""")
    parser.add_argument('gencodeSpliceTsv',
                        help="""gencode splice TSV""")
    opts = parser.parse_args()
    loggingOps.setupFromCmd(opts, sys.argv[0])
    return opts


def writeSjInfoRow(sjInfoFh, pathConfig, rnaSeqData):
    # need abs path, since we store this in tmp
    sjOut = os.path.abspath(pathConfig.rnaSeqSetAnalysisSjOut(rnaSeqData.setname, rnaSeqData.runname))
    if not os.path.exists(sjOut):
        raise Exception("missing splice junction file: {}".format(sjOut))
    fileOps.prRowv(sjInfoFh, rnaSeqData.runname, rnaSeqData.tissue, sjOut)


def makeSjInfoFile(pathConfig, organism):
    "create input file for rslSpliceJunctionCollectEvidence"
    sjInfoFile = fileOps.tmpFileGet("sjInfo")
    with open(sjInfoFile, "w") as sjInfoFh:
        fileOps.prRowv(sjInfoFh, "spliceJuncFile", "runname", "tissue")
        for rnaSeqData in RnaSeqData.select().where(RnaSeqData.organism == organism):
            writeSjInfoRow(sjInfoFh, pathConfig, rnaSeqData)
    return sjInfoFile


def runSjCollectEvidence(pathConfig, minOverhang, sjInfoFile, gencodeGenePred, gencodeSpliceTsv):
    supportTsv = pathConfig.rnaSeqSetSupportTsv()
    fileOps.ensureFileDir(supportTsv)
    supportTsvTmp = fileOps.atomicTmpFile(supportTsv)
    pipettor.run(["rslSpliceJunctionCollectEvidence",
                  "-minOverhang={}".format(minOverhang),
                  gencodeGenePred, gencodeSpliceTsv, sjInfoFile, supportTsvTmp],
                 logger=logging.getLogger())
    fileOps.atomicInstall(supportTsvTmp, supportTsv)


def sjCollectEvidence(opts):
    pathConfig = config.PathConfig(opts.rootDir, opts.organism, opts.assembly, opts.geneSet)
    database = SqliteDatabase(pathConfig.dataDatabase())
    setDatabase(database)
    sjInfoFile = makeSjInfoFile(pathConfig, opts.organism)
    runSjCollectEvidence(pathConfig, opts.minOverhang, sjInfoFile, opts.gencodeGenePred, opts.gencodeSpliceTsv)
    os.unlink(sjInfoFile)

sjCollectEvidence(parseArgs())
