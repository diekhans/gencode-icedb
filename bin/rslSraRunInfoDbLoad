#!/usr/bin/env python3
import icedbProgSetup  # noqa: F401
import sys
import argparse
from gencode_icedb.rsl.rslModel import rslConnect, RunMetadata
from pycbio.sys import loggingOps
from pycbio.tsv import TsvReader

bulk_size = 150   # size of each bulk insert


def parseArgs():
    desc = """Load run metadata from runinfo TSV files into a database.
    """
    parser = argparse.ArgumentParser(description=desc)
    loggingOps.addCmdOptions(parser)
    parser.add_argument('--srcsymid', default="SRA",
                        help="""source name to use in records""")
    parser.add_argument('rsldb',
                        help="""sqllite3 database, tables are created as needed""")
    parser.add_argument('runinfoTsv',
                        help="""SRA runinfo TSV (see rslSraRunInfoFilter program)""")
    opts = parser.parse_args()
    loggingOps.setupFromCmd(opts, sys.argv[0])
    return opts


def orgToOrgCode(org):
    if org == "Homo sapiens":
        return "hs"
    elif org.startswith("Mus musculus"):
        return "mm"
    else:
        raise Exception("unsupported organism: {}".format(org))


def noneIfEmpty(s):
    return s if len(s) > 0 else None


def makeRunMetaRec(srcsymid, row):
    return {"src_symid": srcsymid,
            "run_acc": row.Run,
            "org_code": orgToOrgCode(row.ScientificName),
            "tumor": noneIfEmpty(row.Tumor),
            "tissue": noneIfEmpty(row.Body_Site)}


def readRunInfo(srcsymid, runinfoTsv):
    "load RunMetadata fields for bulk load"
    return [makeRunMetaRec(srcsymid, row) for row in TsvReader(runinfoTsv)]


def dbLoad(dbconn, recs):
    with dbconn.atomic():
        for idx in range(0, len(recs), bulk_size):
            RunMetadata.insert_many(recs[idx:idx + bulk_size]).execute()


def rslSraRunInfoDbLoad(opts):
    recs = readRunInfo(opts.srcsymid, opts.runinfoTsv)
    dbconn = rslConnect(opts.rsldb, readonly=False)
    RunMetadata.create_table(fail_silently=True)
    dbLoad(dbconn, recs)


rslSraRunInfoDbLoad(parseArgs())
