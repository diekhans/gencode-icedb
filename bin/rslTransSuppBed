#!/usr/bin/env python

from __future__ import print_function
import icedbProgSetup  # noqa: F401
import sys
import argparse
from pycbio.sys import loggingOps
import sqlite3
from gencode_icedb.general import gencodeDb
from gencode_icedb.general.annotFeatures import AnnotationGenePredFactory
from gencode_icedb.rsl.gencodeIntronEvid import IntronSupportLevel
from gencode_icedb.rsl.supportAnalysis import GencodeIntronEvid, SupportTrackColors
from pycbio.hgdata.hgLite import GenePredDbTable
from gencode.data.gencodeGenes import BioType


def parseArgs():
    desc = """Create a BED of full transcript support"""
    parser = argparse.ArgumentParser(description=desc)
    loggingOps.addCmdOptions(parser)
    parser.add_argument("--level", action="append",
                        choices=[str(l) for l in IntronSupportLevel],
                        help="level to include, maybe repeated")
    parser.add_argument("--biotype", action="append",
                        choices=[str(b) for b in BioType.values],
                        help="biotype to include, maybe repeated")
    parser.add_argument('gencodeDb',
                        help="GENCODE database")
    parser.add_argument('intronEvidDb',
                        help="support or novel database")
    parser.add_argument('bedOut',
                        help="output BED file")
    opts = parser.parse_args()
    loggingOps.setupFromCmd(opts, sys.argv[0])
    if opts.level is not None:
        opts.level = frozenset([IntronSupportLevel(l) for l in opts.level])
    else:
        opts.level = frozenset(list(IntronSupportLevel))
    if opts.biotype is not None:
        opts.biotype = frozenset([BioType(b) for b in opts.biotype])
    return opts


class BedMaker(object):
    def __init__(self, levels, bioTypes, gie):
        self.levels = levels
        self.bioTypes = bioTypes
        self.gie = gie

    def __reportBiotype(self, transAnn):
        if self.bioTypes is None:
            return True
        else:
            return self.gie.byTransIds[transAnn.rnaName].bioType in self.bioTypes
        
    def __shouldReport(self, transAnn):
        transEvid = self.gie.byTransIds.get(transAnn.rnaName)
        if transEvid is None:
            return False
        if transEvid.fullSupportLevel() not in self.levels:
            return False
        if not self.__reportBiotype(transAnn):
            return False
        return True

    def __writeBedRec(self, transAnn, bedFh):
        if self.__shouldReport(transAnn):
            transEvid = self.gie.byTransIds[transAnn.rnaName]
            itemRgb = SupportTrackColors.supportLevelColor(transEvid.fullSupportLevel()).toRgb8Str()
            transAnn.toBed(itemRgb).write(bedFh)

    def writeBed(self, gencodeDbConn, bedFh):
        annFactory = AnnotationGenePredFactory()
        for gp in GenePredDbTable(gencodeDbConn, gencodeDb.gencode_ann_table).queryAll():
            self.__writeBedRec(annFactory.fromGenePred(gp), bedFh)


def rslIntronSuppBed(opts):
    gie = GencodeIntronEvid()
    gie.loadSupportDb(opts.intronEvidDb, None)
    gie.loadGencodeDb(opts.gencodeDb)
    bedMaker = BedMaker(opts.level, opts.biotype, gie)
    gencodeDbConn = sqlite3.connect(opts.gencodeDb)
    with open(opts.bedOut, "w") as bedFh:
        bedMaker.writeBed(gencodeDbConn, bedFh)
    gencodeDbConn.close()


rslIntronSuppBed(parseArgs())
