#!/bin/env python

import sys
import os
import argparse
from shutil import copyfile
sys.path.insert(0, os.path.expanduser("~markd/compbio/code/pycbio"))
from pycbio.sys import fileOps
from pycbio.sys import procOps
from pycbio.sys.pipeline import DataReader


def parseArgs():
    desc = """Map reads to a genome with annotations and save splice junction mapping
    information,"""
    parser = argparse.ArgumentParser(description=desc)
    parser.add_argument('--numThreads', type=int,
                        help="number of threads to use")
    parser.add_argument('--tmpDir',
                        help="""temporary directory to use; a directory with a unique name is created under here and removed after.  Defaults to value of TMPDIR""")
    parser.add_argument('genomeDir',
                        help="""directory to contain all the generated files;
                        this must not exist; Log.out is also saved in this directory""")
    parser.add_argument('readsFile',
                        help="""input reads in SAM, BAM or Fastq format, which maybe compressed""")
    parser.add_argument('sjOut',
                        help="""splice junction output file """)
    return parser.parse_args()

def getReadsCommands(opts):
    # FIXME: add better checking
    if opts.readsFile.endswith(".gz"):
        return ['zcat', opts.readsFile]
    elif opts.readsFile.endswith(".bz2"):
        return ['bzcat', opts.readsFile]
    else:
       return ["samtools", "bam2fq", opts.readsFile]

def starSpliceJunctionMap(opts):
    starTmpDir = fileOps.tmpFileGet(prefix="star", tmpDir=opts.tmpDir)
    # holds output files before filtering
    outputTmpDir = fileOps.tmpFileGet(prefix="starout", tmpDir=opts.tmpDir)
    sjTmpOut = os.path.join(outputTmpDir, "SJ.out.tab")
    fileOps.ensureDir(outputTmpDir)
    cmd = ["STAR",
           "--runMode", "alignReads",
           "--runThreadN", opts.numThreads,
           "--outSAMmode", "None",
           "--genomeDir", opts.genomeDir,
           "--readFilesIn", "/dev/stdin",
           "--outTmpDir", starTmpDir,
           "--outFileNamePrefix", outputTmpDir+"/"]
    procOps.runProc((getReadsCommands(opts), cmd), stderr=DataReader)
    copyfile(sjTmpOut, opts.sjOut)
    fileOps.rmTree(outputTmpDir)


starSpliceJunctionMap(parseArgs())
