#!/usr/bin/env python3
from __future__ import print_function

import os
import sys
sys.path.insert(0, os.path.join(os.path.dirname(__file__), "../../../../bin"))
import icedbProgSetup  # noqa: F401
import argparse
import pipettor
import logging
from pycbio.sys import fileOps
from testlib import TestCases


def parseArgs():
    desc = """Create test data from TSV specifying test genes.  This
    get GENCODE genePreds and evidence PSLs."""
    parser = argparse.ArgumentParser(description=desc)
    parser.add_argument('--debug', action="store_true", default=False,
                        help="""Enable debug logging""")
    parser.add_argument('testCaseTsv',
                        help="""TSV contain gene/transcripts to obtain.""")
    parser.add_argument('gencodeVersion',
                        help="""GENCODE version in the form V27 or VM13""")
    parser.add_argument('ucscDb',
                        help="""UCSC database for GENCODE and RNA/ESTs""")
    parser.add_argument('ensemblCDnaDb',
                        help="""Ensembl database for cDNAs""")
    parser.add_argument('assemblyReport',
                        help="""NCBI assembly report for mapping chromosome names""")
    parser.add_argument('evidDb',
                        help="""evidence database to load alignments into""")
    parser.add_argument('gencodeDb',
                        help="""database to load gencode annotations into""")
    return parser.parse_args()


def mkChromSpecs(opt, ranges):
    return ["{}={}".format(opt, str(r)) for r in ranges]


def getUcscAlns(ucscDb, alntype, ranges, evidDbFile):
    cmd = ["tslGetUcscRnaAligns", ucscDb, alntype, evidDbFile] + mkChromSpecs("-chromSpec", ranges)
    pipettor.run(cmd)


def getEnsemblAlns(ensemblCDnaDb, assemblyReport, ranges, evidDbFile):
    cmd = ["tslGetEnsemblRnaAligns", ensemblCDnaDb, assemblyReport, evidDbFile] + mkChromSpecs("--chromSpec", ranges)
    pipettor.run(cmd)


def getProblemCases(ucscDb, evidDbFile):
    tsvPre = "hs" if ucscDb.startswith("hg") else "mm"
    probTsv = os.path.join(icedbProgSetup.rootDir, "data", "{}.genbank-problem-cases.tsv".format(tsvPre))
    cmd = ["tslGenbankProblemCasesLoad", probTsv, evidDbFile]
    pipettor.run(cmd)


def buildEvidDb(testCases, assemblyReport, ucscDb, ensemblCDnaDb, evidDbFile):
    fileOps.rmFiles(evidDbFile)
    ranges = testCases.getRanges()
    getUcscAlns(ucscDb, "rna", ranges, evidDbFile)
    getUcscAlns(ucscDb, "est", ranges, evidDbFile)
    getEnsemblAlns(ensemblCDnaDb, assemblyReport, ranges, evidDbFile)
    getProblemCases(ucscDb, evidDbFile)


def writeTransIdsTmpFile(testCases):
    transIdTmp = fileOps.tmpFileGet("transIds")
    with open(transIdTmp, 'w') as fh:
        for gene in testCases.values():
            for trans in gene:
                print(trans.transcriptId, file=fh)
    return transIdTmp


def buildGencodeDb(testCases, ucscDb, gencodeVersion, gencodeDb):
    fileOps.rmFiles(gencodeDb)
    transIdTmp = writeTransIdsTmpFile(testCases)
    cmd = ["ucscGencodeDbLoad",
           "--hgdb={}".format(ucscDb),
           "--version={}".format(gencodeVersion),
           "--transIds={}".format(transIdTmp),
           gencodeDb]
    try:
        pipettor.run(cmd)
    finally:
        os.unlink(transIdTmp)


def createTestData(args):
    if args.debug:
        logging.getLogger().setLevel(logging.DEBUG)
        pipettor.setDefaultLogger(logging.getLogger())
        pipettor.setDefaultLogLevel(logging.DEBUG)
        logging.debug("Debugging enabled")  # FIXME for some reason, this is required to start output
    testCases = TestCases(args.testCaseTsv)
    buildGencodeDb(testCases, args.ucscDb, args.gencodeVersion, args.gencodeDb)
    buildEvidDb(testCases, args.assemblyReport, args.ucscDb, args.ensemblCDnaDb, args.evidDb)


createTestData(parseArgs())
